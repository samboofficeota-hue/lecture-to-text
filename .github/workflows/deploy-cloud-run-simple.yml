name: Deploy to Cloud Run (Simple)

on:
  push:
    branches: [ main ]
    paths:
      - 'cloud_run_api.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'text_enhancer.py'
      - 'config.py'
      - 'deploy-cloud-run.sh'
      - '.github/workflows/deploy-cloud-run-simple.yml'
  workflow_dispatch:

env:
  PROJECT_ID: lecture-to-text-472009
  SERVICE_NAME: lecture-to-text-api
  REGION: asia-northeast1
  IMAGE_NAME: gcr.io/lecture-to-text-472009/lecture-to-text-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Deploy using manual script approach
      run: |
        echo "ğŸš€ Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™..."
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’è¨­å®š
        echo "ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’è¨­å®šä¸­..."
        gcloud config set project ${{ env.PROJECT_ID }}
        
        # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
        echo "ğŸ”¨ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
        gcloud builds submit --tag ${{ env.IMAGE_NAME }} .
        
        # Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤
        echo "â˜ï¸ Cloud Runã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.IMAGE_NAME }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --memory 4Gi \
          --cpu 2 \
          --timeout 3600 \
          --max-instances 10
        
        echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
        echo "ğŸŒ ã‚µãƒ¼ãƒ“ã‚¹URL: https://${{ env.SERVICE_NAME }}-${{ env.REGION }}-${{ env.PROJECT_ID }}.a.run.app"
