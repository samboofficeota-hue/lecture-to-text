name: Deploy New Architecture to Cloud Run

on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/cloud_run_api_new.py'
      - 'core/**'
      - 'adapters/**'
      - 'config/**'
      - 'utils/**'
      - 'learning/**'
      - 'requirements.txt'
      - 'Dockerfile.new'
      - '.github/workflows/deploy-new-architecture.yml'
  workflow_dispatch:

env:
  PROJECT_ID: lecture-to-text-472009
  SERVICE_NAME: darwin-lecture-api
  REGION: asia-northeast1
  IMAGE_NAME: gcr.io/lecture-to-text-472009/darwin-lecture-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Deploy New Architecture
      run: |
        echo "🚀 新しいアーキテクチャのCloud Runデプロイを開始します..."
        
        # プロジェクトIDを設定
        echo "📝 プロジェクトIDを設定中..."
        gcloud config set project ${{ env.PROJECT_ID }}
        
        # 新しいDockerfileを使用してイメージをビルド
        echo "🔨 新しいアーキテクチャのDockerイメージをビルド中..."
        gcloud builds submit --tag ${{ env.IMAGE_NAME }} .
        
        # 新しいCloud Runサービスにデプロイ
        echo "☁️ 新しいCloud Runサービスにデプロイ中..."
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.IMAGE_NAME }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --memory 16Gi \
          --cpu 4 \
          --timeout 3600 \
          --max-instances 10 \
          --set-env-vars GCP_PROJECT_ID=${{ env.PROJECT_ID }},NEXT_PUBLIC_API_KEY=test-api-key-12345,OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }},MYGPT_API_KEY=${{ secrets.MYGPT_API_KEY }},WHISPER_MODEL=${{ secrets.WHISPER_MODEL }},WHISPER_DEVICE=${{ secrets.WHISPER_DEVICE }},WHISPER_COMPUTE_TYPE=${{ secrets.WHISPER_COMPUTE_TYPE }},RAG_USE_MYGPT=${{ secrets.RAG_USE_MYGPT }},RAG_USE_CHATGPT=${{ secrets.RAG_USE_CHATGPT }},OUTPUT_DIR=./output,TEMP_DIR=./temp,BACKUP_DIR=./backup,LOG_LEVEL=${{ secrets.LOG_LEVEL }},DEBUG=false,PROJECT_NAME=Darwin,GCP_REGION=${{ secrets.GCP_REGION }}
        
        echo "✅ 新しいアーキテクチャのデプロイ完了！"
        echo "🌐 サービスURL: https://${{ env.SERVICE_NAME }}-${{ env.REGION }}-${{ env.PROJECT_ID }}.a.run.app"
